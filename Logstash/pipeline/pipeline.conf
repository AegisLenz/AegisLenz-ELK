input {
    beats {
        port => 5045
        codec => json {
            charset => "UTF-8"
            target => "parsed_message"
        }
    }
}

filter {
    if [parsed_message] and [parsed_message][Records] {
        split { field => "[parsed_message][Records]" }

        mutate {
            rename => { "[parsed_message][Records]" => "record" }
        }

        if [record][eventName] not in [
            "ConsoleLogin", 
            "AssumeRole", 
            "AttachRolePolicy", 
            "DetachRolePolicy", 
            "PutUserPolicy", 
            "GetObject", 
            "PutObject", 
            "CreateAccessKey", 
            "PutBucketAcl", 
            "DeleteBucketPolicy"
        ] {
            drop { }
        }

        ruby {
            code => '
                def flatten_hash(hash, prefix = "")
                  hash.each_with_object({}) do |(key, value), result|
                    if value.is_a?(Hash)
                      result.merge!(flatten_hash(value, "#{prefix}#{key}.")) 
                    elsif value.is_a?(Array)
                      value.each_with_index do |item, index|
                        if item.is_a?(Hash)
                          result.merge!(flatten_hash(item, "#{prefix}#{key}[#{index}].")) 
                        else
                          result["#{prefix}#{key}[#{index}]"] = item
                        end
                      end
                    else
                      result["#{prefix}#{key}"] = value
                    end
                  end
                end

                record_data = event.get("record")
                if record_data
                  flattened = flatten_hash(record_data)
                  flattened.each do |key, value|
                    event.set(key, value)
                  end
                end
            '
        }

        mutate {
            add_field => {
                "log_summary" => "%{[record][eventName]} from %{[record][sourceIPAddress]} by %{[record][userAgent]}"
            }
            remove_field => [
                "parsed_message", 
                "host", 
                "agent", 
                "@metadata", 
                "responseElements", 
                "requestParameters"
            ]
        }
    } else {
        drop { }
    }
}

output {
    elasticsearch {
        hosts => ["${ELASTIC_HOST}"]
        index => "cloudtrail-logs-%{+YYYY.MM.dd}"
        ssl_verification_mode => "none"
        ecs_compatibility => "v8"
        document_id => "%{[record][eventID]}"
        template_overwrite => true
    }

    if "malicious_ip" in [tags] {
        elasticsearch {
            hosts => ["${ELASTIC_HOST}"]
            index => "cloudtrail-alerts-%{+YYYY.MM.dd}"
            ssl_verification_mode => "none"
            ecs_compatibility => "v8"
        }
    }

    if [record][eventName] in ["CreateUser", "DeleteUser"] {
        elasticsearch {
            hosts => ["${ELASTIC_HOST}"]
            index => "critical-events-%{+YYYY.MM.dd}"
        }
    }

    stdout {
        codec => line { format => "%{log_summary}" }
    }
}